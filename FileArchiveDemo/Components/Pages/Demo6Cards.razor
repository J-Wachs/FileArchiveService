@page "/demo6cards"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using FileArchive
@using FileArchive.Interfaces
@using FileArchive.Models
@using FileArchive.Services
@using FileArchive.Utils
@inject IConfiguration config

@inject IFileArchiveStorage fileArchiveStorage
@inject IFileArchiveFileInfoCRUD fileArchiveFileInfoCRUD

<PageTitle>Demo 6: Use FileArchiveList component outside an EditForm</PageTitle>

<h1>Demo 6: Use FileArchiveList component outside an EditForm</h1>

<p>This demo shows:</p>
<ul>
    <li>Use the FileArchiveList component outside an EditForm component</li>
    <li>The user can add <u>one file</u></li>
    <li>The user can delete files</li>
    <li>The description of each file is displayed and the user can edit/enter it</li>
    <li>Each file must be less than or equal to 20000 bytes in size</li>
    <li>There can be only 3 files in the archive</li>
    <li>Filetypes allowed are PNG, JPG and JPEG</li>
    <li>The user can download the files one at the time</li>
    <li>Error messages are displayed in a JavaScript alert popup dialog</li>
</ul>
<br />


@if (!string.IsNullOrEmpty(Message))
{
    <span style="color: red; font-weight: bold;">@Message</span>
}

<div class="form-control">
    <div class="form-group row">
        <label for="demouimodel-files" class="col-sm-2 col-form-label">Files:</label>
        <div class="col-sm-10">
            <FileArchiveCards @ref="FileArchiveComponent" Files="Files"
                             FileTypesAccepted=".png,.jpg,.jpeg"
                             AllowSelectMultipleFiles="false"
                             AllowAdd="true"
                             AllowUpdate="true"
                             AllowUpdateOnNew="true"
                             AllowDownload="true"
                             AllowDelete="true"
                             DisplayDescription="true"
                             DisplayExistingFiles="true"
                             MaxFileSize="20000"
                             AllowedNbrOfFiles="3"
                             Height="300px">
            </FileArchiveCards>
        </div>
    </div>
    <div class="form-group row">
        <div class="col-sm-10">
            <button type="button" onclick="@SubmitForm" class="btn btn-primary mt-3">Submit form</button>
        </div>
    </div>
</div>

@code {
    private FileArchiveCards? FileArchiveComponent;
    private string Message = string.Empty;
    public List<FileArchiveFileInfoUI>? Files { get; set; }

    private IFileArchiveCRUD? fileArchiveCRUD;

    private long reportId = 4712; // In a real-world application,
                                  // the Id is returned by e.g.
                                  // the SQL server.

    private string userId = "8888-9999";

    protected override void OnInitialized()
    {
        fileArchiveCRUD = new FileArchiveCRUD(fileArchiveFileInfoCRUD,
                                              fileArchiveStorage);
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && fileArchiveCRUD is not null)
        {
            string parentKey = reportId.ToString();
            Result<List<FileArchiveFileInfoUI>> getListOfFilesResult = await fileArchiveCRUD.GetListOfFileInfoUIForArchive(parentKey);
            if (getListOfFilesResult.IsSuccess is false)
            {
                Message = String.Join(", ", getListOfFilesResult.Messages);
            }
            else
            {
                Message = string.Empty;
                Files = getListOfFilesResult.Data!;
            }
            StateHasChanged();
        }

        base.OnAfterRender(firstRender);
    }


    private async Task SubmitForm()
    {
        // If the component is used in a CREATE situation, then
        // you must do what is nessecary to establish the key that
        // is going to be the ParentKey for the files.
        // That is, in this example we are to create an incident
        // report. Data must be written to the storage (database),
        // and the key must be obtained, as it will serve as a
        // parent key for the storage of information for the files.

        // Save Incident report data
        //

        // Obtain key
        // reportId = ....

        // Store files
        string parentKey = reportId.ToString();
        var result = await fileArchiveCRUD!.CreateUpdateDeleteArchiveFromUI(parentKey, FileArchiveComponent!, userId);
    }
}
